name: Spark Tests (Prebuilt Image)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# Allow the runner to authenticate to GitHub Packages (GHCR) before job containers
# are started. Container image pulls happen before job-level permissions apply, so
# set these at the workflow root.
permissions:
  contents: read
  packages: read

jobs:
  test:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/hutchisonkim/spark-dotnet:3.5.3-2.3.0
      options: --init
    permissions:
      contents: read
      packages: read
    env:
      TEST_CLASS: Game.Chess.Tests.Unit.ChessSparkPolicyTests
      SPARK_HOME: /opt/spark
      DOTNET_WORKER_DIR: /opt/microsoft-spark-worker

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Run Spark test
        run: |
          dotnet test \
            --no-build \
            --filter "FullyQualifiedName~${TEST_CLASS}" \
            --verbosity normal
