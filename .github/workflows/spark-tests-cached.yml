name: Spark Tests (Prebuilt Image)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    env:
      TEST_CLASS: Game.Chess.Tests.Unit.ChessSparkPolicyTests
      SPARK_HOME: /opt/spark
      DOTNET_WORKER_DIR: /opt/microsoft-spark-worker

    steps:
      # 1️⃣ Checkout code
      - uses: actions/checkout@v4

      # 2️⃣ Log in to GitHub Container Registry (GHCR)
      - name: Log in to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: hutchisonkim
          password: ${{ secrets.GHCR_PAT }}

      # 3️⃣ Pull prebuilt Spark image
      - name: Pull Spark Docker image
        run: docker pull ghcr.io/hutchisonkim/spark-dotnet:3.5.3-2.3.0

      # 4️⃣ Run steps inside the container
      - name: Run in Spark container
        uses: addnab/docker-run-action@v3
        with:
          image: ghcr.io/hutchisonkim/spark-dotnet:3.5.3-2.3.0
          options: --init
          run: |
            # Setup .NET inside container
            dotnet build --configuration Release --no-restore

            # Run only the specified Spark test class
            dotnet test \
              --no-build \
              --filter "FullyQualifiedName~${TEST_CLASS}" \
              --verbosity normal
