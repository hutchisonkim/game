name: Spark Tests (Prebuilt Image)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    container:
      image: ghcr.io/${{ github.repository_owner }}/spark-dotnet:3.5.3-2.3.0
      options: --init
      credentials:
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GHCR_PAT }}

    env:
      TEST_CLASS: Game.Chess.Tests.Unit.ChessSparkPolicyTests
      SPARK_HOME: /opt/spark
      DOTNET_WORKER_DIR: /opt/microsoft-spark-worker
      DOTNET_CLI_TELEMETRY_OPTOUT: '1'
      DOTNET_CLI_HOME: /github/home

    steps:
      - name: Prepare Microsoft.Spark.dll for build
        run: |
          echo "üîß Checking for Microsoft.Spark.dll..."
          WORKER_DLL=$(find "$DOTNET_WORKER_DIR" -type f -name "Microsoft.Spark.dll" | head -n 1 || true)
          if [ -z "$WORKER_DLL" ]; then
            echo "‚ùå Could not locate Microsoft.Spark.dll in $DOTNET_WORKER_DIR"
            exit 1
          fi

          echo "‚úÖ Found Microsoft.Spark.dll at: $WORKER_DLL"
          echo "Copying to expected NuGet package directory..."

          NUGET_DIR="/github/home/.nuget/packages/microsoft.spark/2.3.0/lib/netstandard2.1"
          mkdir -p "$NUGET_DIR"
          cp "$WORKER_DLL" "$NUGET_DIR/Microsoft.Spark.dll"

          # Ensure correct ownership and readability for the runner user
          chmod 644 "$NUGET_DIR/Microsoft.Spark.dll"
          chown "$(id -u):$(id -g)" "$NUGET_DIR/Microsoft.Spark.dll"

          echo "‚úÖ Copied Microsoft.Spark.dll to: $NUGET_DIR"
          ls -la "$NUGET_DIR"

          echo "Verifying accessibility..."
          dotnet --info | grep 'Base Path' || true
          ls -la /github/home/.nuget/packages/microsoft.spark/2.3.0/lib/netstandard2.1

      - uses: actions/checkout@v4

      - name: Build & Run Spark tests (focused logging)
        run: |
          set -e
          cd tests/Game.Chess.Tests.Unit

          echo "=== Info ==="
          dotnet --info

          echo
          echo "=== NuGet Sources ==="
          dotnet nuget list source

          echo
          echo "=== Restoring Project Packages (detailed logging) ==="
          dotnet restore Game.Chess.Tests.Unit.csproj --verbosity detailed --runtime linux-x64

          echo "dotnet list package (after restore)"
          dotnet list package --include-transitive

          echo "ls ~/.nuget/packages/microsoft.spark -R || true"
          ls -la ~/.nuget/packages/microsoft.spark || true
          find ~/.nuget/packages -type f -name "Microsoft.Spark.dll" -print || true

          echo
          echo "=== Building Project (minimal logging) ==="
          dotnet build Game.Chess.Tests.Unit.csproj --configuration Release --verbosity minimal --runtime linux-x64

          echo
          echo "=== Running Specified Spark Test Class ==="
          dotnet test Game.Chess.Tests.Unit.csproj \
            --no-build \
            --runtime linux-x64 \
            --filter "FullyQualifiedName~${TEST_CLASS}" \
            --verbosity normal
