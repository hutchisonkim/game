name: Spark Tests (Prebuilt Image)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    container:
      image: ghcr.io/${{ github.repository_owner }}/spark-dotnet:3.5.3-2.3.0
      options: --init
      credentials:
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GHCR_PAT }}

    env:
      TEST_CLASS: Game.Chess.Tests.Unit.ChessSparkPolicyTests
      SPARK_HOME: /opt/spark
      DOTNET_WORKER_DIR: /opt/microsoft-spark-worker
      DOTNET_CLI_TELEMETRY_OPTOUT: '1'

    steps:
      - uses: actions/checkout@v4

      - name: Build & Run Spark tests with verbose logging
        run: |
          set -e
          cd tests/Game.Chess.Tests.Unit

          echo "=== .NET SDK Info ==="
          dotnet --info

          echo
          echo "=== Restoring NuGet Packages ==="
          # Show which package sources are available
          dotnet nuget list source
          
          # Restore project with detailed verbosity
          dotnet restore Game.Chess.Tests.Unit.csproj --verbosity detailed

          echo
          echo "=== Listing Microsoft.Spark.dll after restore (debug) ==="
          find ~/.nuget/packages -type f -name "Microsoft.Spark.dll" || echo "Microsoft.Spark.dll not found!"

          echo
          echo "=== Building Project ==="
          dotnet build Game.Chess.Tests.Unit.csproj --configuration Release --verbosity detailed

          echo
          echo "=== Running Specified Spark Test Class ==="
          dotnet test Game.Chess.Tests.Unit.csproj \
            --no-build \
            --filter "FullyQualifiedName~${TEST_CLASS}" \
            --verbosity normal
