name: Spark Tests (Prebuilt Image)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    container:
      image: ghcr.io/${{ github.repository_owner }}/spark-dotnet:3.5.3-2.3.0
      options: --init
      credentials:
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GHCR_PAT }}

    env:
      TEST_CLASS: Game.Chess.Tests.Unit.ChessSparkPolicyTests
      SPARK_HOME: /opt/spark
      SPARK_VERSION: "3.5.3"
      DOTNET_WORKER_DIR: /opt/microsoft-spark-worker
      DOTNET_CLI_TELEMETRY_OPTOUT: '1'
      DOTNET_CLI_HOME: /github/home
      NUGET_PACKAGES: /github/home/.nuget
      DOTNETBACKEND_PORT: "5567"



    steps:
      - uses: actions/checkout@v4

      - name: Setup NuGet cache
        run: |
          dotnet nuget locals all --clear
          mkdir -p "$NUGET_PACKAGES"
          chmod -R 777 "$NUGET_PACKAGES"

      - name: Restore and fix NuGet packages
        shell: bash
        run: |
          cd tests/Game.Chess.Tests.Unit
          
          echo "Restoring packages..."
          dotnet restore --runtime linux-x64

          echo "Fixing Windows-style paths in NuGet cache..."
          find "$NUGET_PACKAGES" -depth -name '*\\*' -print0 | while IFS= read -r -d '' f; do
            NEW_PATH=$(echo "$f" | sed 's/\\/\//g')
            NEW_PATH="${NEW_PATH%/}"
            if [ -d "$f" ]; then
              mkdir -p "$NEW_PATH"
              mv "$f"/* "$NEW_PATH"/ 2>/dev/null || true
              rmdir "$f" 2>/dev/null || true
            else
              mkdir -p "$(dirname "$NEW_PATH")"
              mv "$f" "$NEW_PATH"
            fi
          done

          echo "NuGet packages ready"

      - name: Start Spark Backend + Run Tests
        shell: bash
        env:
          SPARK_HOME: /opt/spark
          DOTNET_WORKER_DIR: /opt/microsoft-spark-worker
          DOTNETBACKEND_PORT: "5567"
        run: |
          set -euo pipefail

          cd tests/Game.Chess.Tests.Unit

          apt-get update -qq && apt-get install -y -qq netcat-openbsd

          echo "Building test project..."
          dotnet build -c Release -r linux-x64 --no-restore

          SPARK_JAR="./bin/Release/net8.0/linux-x64/microsoft-spark-3-5_2.12-2.3.0.jar"
          [ -f "$SPARK_JAR" ] || { echo "JAR not found: $SPARK_JAR"; exit 1; }

          WORKER_DLL="$DOTNET_WORKER_DIR/Microsoft.Spark.Worker/Microsoft.Spark.Worker.dll"
          [ -f "$WORKER_DLL" ] || { echo "Worker DLL not found: $WORKER_DLL"; exit 1; }

          echo "Starting Spark backend in backend-only mode..."
          nohup dotnet "$WORKER_DLL" \
            --host 127.0.0.1 \
            --port 5567 \
            --sparkHome "$SPARK_HOME" \
            --jars "$SPARK_JAR" \
            > /tmp/spark-backend.log 2>&1 &

          echo "Waiting for backend on port 5567..."
          timeout=10
          while [ "$timeout" -gt 0 ]; do
            if nc -z 127.0.0.1 5567 2>/dev/null; then
              echo "Backend ready on port 5567"
              break
            fi
            sleep 1
            timeout=$((timeout - 1))
          done

          [ "$timeout" -gt 0 ] || { echo "Backend failed to start:"; cat /tmp/spark-backend.log; exit 1; }

          echo "Running tests against backend..."
          dotnet test \
            --no-build \
            -c Release \
            -r linux-x64 \
            --filter "FullyQualifiedName~${{ env.TEST_CLASS }}" \
            --verbosity normal || { echo "Tests failed. Logs:"; cat /tmp/spark-backend.log; exit 1; }

          echo "Tests passed!"
          cat /tmp/spark-backend.log