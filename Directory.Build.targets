<Project>
  <PropertyGroup>
    <!-- default compose file at repo root -->
    <DockerComposeFile>$(MSBuildThisFileDirectory)docker-compose.yml</DockerComposeFile>
  </PropertyGroup>

  <!-- Override the VSTest target provided by Microsoft.NET.Test.Sdk
       For projects that set RunTestsInContainer=true we will run the tests inside the test-runner container
       so they have access to Spark/spark-submit. For other projects we fall back to dotnet vstest on the host.
  -->
  <Target Name="VSTest">
    <Message Importance="high" Text="Custom VSTest target invoked for $(MSBuildProjectName). RunTestsInContainer=$(RunTestsInContainer)" />
    <PropertyGroup>
      <RelProj>$([System.IO.Path]::GetRelativePath('$(MSBuildThisFileDirectory)','$(MSBuildProjectDirectory)'))</RelProj>
      <RelProjNormalized>$([System.String]::Copy('$(RelProj)').Replace('\\','/'))</RelProjNormalized>
      <ContainerAssembly>/workspace/$(RelProjNormalized)/bin/$(Configuration)/net8.0/$(AssemblyName).dll</ContainerAssembly>
    </PropertyGroup>

    <Message Importance="high" Text="Running vstest on host for $(MSBuildProjectName)... (docker-compose calls removed; use Testcontainers fixtures instead)" />
    <MakeDir Directories="$(MSBuildProjectDirectory)\TestLogs" Condition="!Exists('$(MSBuildProjectDirectory)\TestLogs')" />
    <Exec Command="dotnet vstest &quot;$(TargetPath)&quot; --logger:trx;LogFileName=$(MSBuildProjectDirectory)\TestLogs\$(MSBuildProjectName).trx" ContinueOnError="false" />
  </Target>
  
  <Target Name="RunIntegrationTests"
        DependsOnTargets="Build"
        Condition="'$(RunTestsInContainer)' == 'true'">

    <Message Importance="high" Text="Starting Spark for $(MSBuildProjectName)" />

    <!-- Bring up Spark using healthcheck -->
    <Exec Command="docker compose up -d spark" />

    <!-- Run tests normally (shows colored output) -->
    <Exec Command="dotnet test --logger &quot;console;verbosity=normal&quot;" />

    <!-- Shutdown services -->
    <Exec Command="docker compose down -v" />
  </Target>
</Project>
