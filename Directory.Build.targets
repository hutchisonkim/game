<Project>
  <PropertyGroup>
    <!-- default compose file at repo root -->
    <DockerComposeFile>$(MSBuildThisFileDirectory)docker-compose.yml</DockerComposeFile>
  </PropertyGroup>

  <!-- Override the VSTest target provided by Microsoft.NET.Test.Sdk
       For projects that set RunTestsInContainer=true we will run the tests inside the test-runner container
       so they have access to Spark/spark-submit. For other projects we fall back to dotnet vstest on the host.
  -->
  <Target Name="VSTest">
    <Message Importance="high" Text="Custom VSTest target invoked for $(MSBuildProjectName). RunTestsInContainer=$(RunTestsInContainer)" />
    <PropertyGroup>
      <RelProj>$([System.IO.Path]::GetRelativePath('$(MSBuildThisFileDirectory)','$(MSBuildProjectDirectory)'))</RelProj>
      <RelProjNormalized>$([System.String]::Copy('$(RelProj)').Replace('\\','/'))</RelProjNormalized>
      <ContainerAssembly>/workspace/$(RelProjNormalized)/bin/$(Configuration)/net8.0/$(AssemblyName).dll</ContainerAssembly>
    </PropertyGroup>

    <Message Importance="high" Text="Running vstest on host for $(MSBuildProjectName)... (docker-compose calls removed; use Testcontainers fixtures instead)" />
    <MakeDir Directories="$(MSBuildProjectDirectory)\TestLogs" Condition="!Exists('$(MSBuildProjectDirectory)\TestLogs')" />
    <!-- Run a helper PowerShell script that reserves a free port and sets DOTNETBACKEND_PORT
      in the same process that executes vstest. The script takes two args: the target dll
      and the desired trx path. -->
    <Exec Command="pwsh -NoProfile -File &quot;$(MSBuildThisFileDirectory)scripts\pretest-run-vstest.ps1&quot; &quot;$(TargetPath)&quot; &quot;$(MSBuildProjectDirectory)\TestLogs\$(MSBuildProjectName).trx&quot;" ContinueOnError="false" />
  </Target>
  
  <Target Name="RunIntegrationTests"
        DependsOnTargets="Build"
        Condition="'$(RunTestsInContainer)' == 'true'">

    <Message Importance="high" Text="Starting Spark for $(MSBuildProjectName)" />

    <!-- Bring up Spark using healthcheck -->
    <Exec Command="docker compose up -d spark" />

    <!-- Run tests inside the test-runner container so Spark and the Microsoft.Spark.Worker
      are available in the same container network (CI-friendly, more reliable). -->
    <Exec Command='docker compose run --rm test-runner bash -c "dotnet test /workspace/$(RelProjNormalized)/$(MSBuildProjectName).csproj --logger \"console;verbosity=normal\""' />

    <!-- Shutdown services -->
    <Exec Command="docker compose down -v" />
  </Target>
</Project>
