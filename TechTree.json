{
  "name": "Tech Tree for Chess Policy Refactoring",
  "version": "1.0.0",
  "date": "2025-12-09",
  "description": "Hierarchical breakdown of required services and their dependencies",
  "levels": {
    "level_0_foundation": {
      "name": "Foundation (Prerequisite)",
      "order": 0,
      "services": [
        {
          "name": "BoardStateProvider",
          "responsibility": "Convert 2D board array → DataFrame with [x, y, piece, color] schema",
          "testId": "L0_Foundation_BoardStateProvider",
          "estimatedComplexity": "low",
          "rules": [],
          "dependencies": []
        },
        {
          "name": "PatternRepository",
          "responsibility": "Load, cache, and dedup all 60+ chess movement patterns",
          "testId": "L0_Foundation_PatternRepository",
          "estimatedComplexity": "medium",
          "rules": [],
          "dependencies": []
        },
        {
          "name": "PerspectiveEngine",
          "responsibility": "Convert pieces → Self/Ally/Foe attributes, compute threat masks",
          "testId": "L0_Foundation_PerspectiveEngine",
          "estimatedComplexity": "low",
          "rules": [],
          "dependencies": ["BoardStateProvider"]
        }
      ]
    },
    "level_1_atomic_moves": {
      "name": "Atomic Moves (Single-Step)",
      "order": 1,
      "services": [
        {
          "name": "PatternMatcher",
          "responsibility": "Apply one pattern to one piece → atomic candidates",
          "testId": "L1_PatternMatcher_Pawn, L1_PatternMatcher_Knight, L1_PatternMatcher_King",
          "estimatedComplexity": "medium",
          "rules": ["A1", "A3", "A7", "A8", "C4", "C5"],
          "dependencies": ["PatternRepository", "PerspectiveEngine"]
        },
        {
          "name": "CandidateGenerator (Atomic Mode)",
          "responsibility": "Collect all atomic pattern matches for all pieces",
          "testId": "L1_CandidateGenerator_SimpleMoves",
          "estimatedComplexity": "low",
          "rules": ["A1", "A3", "A7", "A8"],
          "dependencies": ["PatternMatcher"]
        }
      ]
    },
    "level_2_sliding_moves": {
      "name": "Sliding Moves (Multi-Step)",
      "order": 2,
      "services": [
        {
          "name": "SequenceEngine (Extended)",
          "responsibility": "Expand patterns recursively with full sequence support: In/Out flags, variants, public filtering, parallel moves",
          "testId": "L2_SequenceEngine_BishopSliding, L2_SequenceEngine_RookSliding, L2_SequenceEngine_RecursiveDepthTest, L2_SequenceEngine_InOutFlagsTest, L2_SequenceEngine_VariantRespectTest, L2_SequenceEngine_PublicFlagTest, L2_SequenceEngine_ParallelFlagTest, L2_SequenceEngine_SrcDstConditionsTest, L2_SequenceEngine_BoardStateModificationTest, L2_SequenceEngine_AbsoluteFactionTest",
          "estimatedComplexity": "high",
          "rules": ["A4", "A5", "A6"],
          "dependencies": ["PatternMatcher"]
        },
        {
          "name": "CandidateGenerator (With Sequences)",
          "responsibility": "Merge atomic + sliding candidates, maintain uniqueness",
          "testId": "L2_CandidateGenerator_SlidingMoves",
          "estimatedComplexity": "low",
          "rules": ["A1", "A3", "A4", "A5", "A6", "A7", "A8"],
          "dependencies": ["CandidateGenerator (Atomic Mode)", "SequenceEngine"]
        }
      ]
    },
    "level_3_simulation": {
      "name": "Simulation (Apply Move)",
      "order": 3,
      "services": [
        {
          "name": "SimulationEngine",
          "responsibility": "Apply move to board state: update pieces, flags (Mint, Passing, Threatened)",
          "testId": "L3_SimulationEngine_SimpleMoves, L3_SimulationEngine_FlagUpdates",
          "estimatedComplexity": "medium",
          "rules": ["A1", "A2", "A3", "A4", "A5", "A6", "A7", "A8", "B1", "B2", "B3", "B4", "B5"],
          "dependencies": ["CandidateGenerator (With Sequences)"]
        }
      ]
    },
    "level_4_threats": {
      "name": "Threats (Opponent Moves)",
      "order": 4,
      "services": [
        {
          "name": "ThreatEngine",
          "responsibility": "Compute all cells threatened by opponent in given position",
          "testId": "L4_ThreatEngine_BasicThreats, L4_ThreatEngine_SlidingThreats",
          "estimatedComplexity": "high",
          "rules": ["A8", "C1", "C2", "C3"],
          "dependencies": ["CandidateGenerator (With Sequences)", "SimulationEngine"]
        }
      ]
    },
    "level_5_special_moves": {
      "name": "Special Moves (Multi-Phase)",
      "order": 5,
      "services": [
        {
          "name": "SequenceEngine (Extended)",
          "responsibility": "Handle OutX → InX patterns for promotion, castling, en passant",
          "testId": "L5_SpecialMoves_Castling, L5_SpecialMoves_EnPassant, L5_SpecialMoves_PawnPromotion",
          "estimatedComplexity": "high",
          "rules": ["B1", "B2", "B3", "B4", "B5"],
          "dependencies": ["SequenceEngine"]
        },
        {
          "name": "SimulationEngine (Extended)",
          "responsibility": "Apply piece transformations and flag updates for special moves",
          "testId": "L5_Simulation_Promotion, L5_Simulation_FlagReset",
          "estimatedComplexity": "medium",
          "rules": ["B1", "B2", "B3", "B4", "B5"],
          "dependencies": ["SimulationEngine"]
        }
      ]
    },
    "level_6_legality": {
      "name": "Legality Validation (King Safety)",
      "order": 6,
      "services": [
        {
          "name": "LegalityEngine",
          "responsibility": "Filter moves that leave king in check, detect pins and discovered checks",
          "testId": "L6_Legality_KingSafety, L6_Legality_PinDetection, L6_Legality_DiscoveredCheck",
          "estimatedComplexity": "high",
          "rules": ["C1", "C2", "C3"],
          "dependencies": ["SimulationEngine", "ThreatEngine", "CandidateGenerator (With Sequences)"]
        }
      ]
    },
    "level_7_timeline": {
      "name": "Timeline (Game Tree)",
      "order": 7,
      "services": [
        {
          "name": "TimelineEngine",
          "responsibility": "Orchestrate: Candidates → Legality → Simulation → Threats → Next Perspectives",
          "testId": "L7_Timeline_SingleTurn, L7_Timeline_MultiTurn, L7_Timeline_DepthCutoff",
          "estimatedComplexity": "medium",
          "rules": ["A1", "A2", "A3", "A4", "A5", "A6", "A7", "A8", "B1", "B2", "B3", "B4", "B5", "C1", "C2", "C3"],
          "dependencies": ["CandidateGenerator (With Sequences)", "LegalityEngine", "SimulationEngine", "ThreatEngine"]
        }
      ]
    },
    "level_8_terminal": {
      "name": "Terminal Conditions (Game End)",
      "order": 8,
      "services": [
        {
          "name": "GameStateAnalyzer",
          "responsibility": "Detect checkmate, stalemate, draw conditions",
          "testId": "L8_Terminal_Checkmate, L8_Terminal_Stalemate",
          "estimatedComplexity": "low",
          "rules": ["D1", "D2", "D3", "D4"],
          "dependencies": ["CandidateGenerator (With Sequences)", "LegalityEngine"]
        }
      ]
    }
  },
  "implementationOrder": [
    {
      "phase": 1,
      "name": "Foundation Setup",
      "services": ["BoardStateProvider", "PatternRepository", "PerspectiveEngine"],
      "estimatedWeeks": 2,
      "blocksPhases": [2, 3, 4, 5, 6, 7, 8],
      "canRunInParallel": false
    },
    {
      "phase": 2,
      "name": "Atomic Pattern Matching",
      "services": ["PatternMatcher", "CandidateGenerator (Atomic Mode)"],
      "estimatedWeeks": 2,
      "blocksPhases": [3, 6, 7],
      "canRunInParallel": false,
      "dependencies": [1]
    },
    {
      "phase": 3,
      "name": "Sliding + Sequences",
      "services": ["SequenceEngine", "CandidateGenerator (With Sequences)"],
      "estimatedWeeks": 3,
      "blocksPhases": [4, 5, 6, 7],
      "canRunInParallel": false,
      "dependencies": [2]
    },
    {
      "phase": 4,
      "name": "Simulation Engine",
      "services": ["SimulationEngine"],
      "estimatedWeeks": 2,
      "blocksPhases": [5, 6, 7],
      "canRunInParallel": false,
      "dependencies": [3]
    },
    {
      "phase": 5,
      "name": "Threats & Special Moves",
      "services": ["ThreatEngine", "SequenceEngine (Extended)", "SimulationEngine (Extended)"],
      "estimatedWeeks": 3,
      "blocksPhases": [6, 7],
      "canRunInParallel": true,
      "dependencies": [4]
    },
    {
      "phase": 6,
      "name": "Legality Engine",
      "services": ["LegalityEngine"],
      "estimatedWeeks": 2,
      "blocksPhases": [7, 8],
      "canRunInParallel": false,
      "dependencies": [5]
    },
    {
      "phase": 7,
      "name": "Timeline Engine",
      "services": ["TimelineEngine"],
      "estimatedWeeks": 2,
      "blocksPhases": [8],
      "canRunInParallel": false,
      "dependencies": [6]
    },
    {
      "phase": 8,
      "name": "Game End Detection",
      "services": ["GameStateAnalyzer"],
      "estimatedWeeks": 1,
      "blocksPhases": [],
      "canRunInParallel": false,
      "dependencies": [7]
    }
  ],
  "parallelizationOpportunities": [
    {
      "phases": [5],
      "description": "ThreatEngine and SequenceEngine (Extended) can be developed in parallel as they have no direct interdependencies, only shared dependencies on earlier phases"
    },
    {
      "phases": [2],
      "description": "PatternMatcher and CandidateGenerator (Atomic) are tightly coupled, but CandidateGenerator can start once PatternMatcher interface is defined"
    }
  ],
  "progressMetrics": {
    "phase_1_complete": "Foundation tests all pass (3/3)",
    "phase_2_complete": "L1 tests all pass (3/3)",
    "phase_3_complete": "L2 tests all pass (3/3)",
    "phase_4_complete": "L3 tests all pass (2/2)",
    "phase_5_complete": "L4 + L5 tests all pass (5/5)",
    "phase_6_complete": "L6 tests all pass (3/3)",
    "phase_7_complete": "L7 tests all pass (3/3)",
    "phase_8_complete": "L8 tests all pass (2/2)",
    "critical_path": "Phase 1 → 2 → 3 → 4 → 5 → 6 → 7 → 8",
    "totalEstimatedWeeks": 17
  }
}
